name: Build SpargeAttn Wheels (Windows)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  install-deps:
    runs-on: windows-latest
    strategy:
      matrix:
        python-version: ['3.9']
        cuda-version: ['12.1.1']
      fail-fast: false
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: upgrade pip
      shell: pwsh
      run: |
        python -m pip install --upgrade pip
        
    - name: Get pip cache dir
      id: pip-cache
      shell: python
      run: |
        import os
        import platform
        from os.path import expanduser
    
        home = expanduser("~")
        cache_path = {
          "Linux": f"{home}/.cache/pip",
          "Darwin": f"{home}/Library/Caches/pip",
          "Windows": f"{home}\\AppData\\Local\\pip\\Cache"
        }[platform.system()]
    
        print(f"::set-output name=dir::{cache_path}")
    
    - name: Cache pip
      uses: actions/cache@v4
      with:
        path: ${{ steps.pip-cache.outputs.dir }}
        key: pip-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          pip-${{ runner.os }}-

    - name: Install setuptools wheel ninja
      shell: pwsh
      run: |
        pip install setuptools wheel ninja

    - name: Install torch==2.3.0+cu121 torchvision torchaudio
      shell: pwsh
      run: |
        pip install torch==2.3.0+cu121 torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121

    - name: Install triton-window
      shell: pwsh
      run: |
        pip install triton-windows

